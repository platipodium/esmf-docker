# Github CI configuration file for building ESMF docker images based
# on ubuntu
# 
# SPDX-FileCopyrightText: 2022 Helmholtz-Zentrum hereon
# SPDX-License-Identifier: CC0-1.0
# SPDX-FileContributor Carsten Lemmen <carsten.lemmen@hereon.de

name: Build and Deploy ESMF Docker Images

on:
  push:
    branches: [ master ]

env:
  CI_REGISTRY_IMAGE: ${{ secrets.CI_REGISTRY_IMAGE }}
  CI_REGISTRY: ${{ secrets.CI_REGISTRY }}
  CI_JOB_TOKEN: ${{ secrets.CI_JOB_TOKEN }}

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    - name: Run license compliance check
      run: poetry run reuse lint

  build:
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
    matrix:
      communicator: ["openmpi", "mpich"]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Docker
      uses: actions/setup-docker@v2
    - name: Build Docker image
      run: |
        docker build -t ${CI_REGISTRY_IMAGE}/esmf:v8.4.0-${{ matrix.communicator }} --build-arg VERSION=v8.4.0 --build-arg COMMUNICATOR=${{ matrix.communicator }} .

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      matrix:
        communicator: ["openmpi", "mpich"]
    steps:
    - uses: actions/checkout@v2
    - name: Set up Docker
      uses: actions/setup-docker@v2
    - name: Log in to Docker registry
      run: docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - name: Build and push Docker image
      run: |
        docker push ${CI_REGISTRY_IMAGE}/esmf:v8.4.0-${{ matrix